<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”µå­é¢å• Canvas ç”Ÿæˆå™¨ (100mm x 50mm)</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- JsBarcode (ç”¨äºç”Ÿæˆæ¡å½¢ç ) -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- QRCode (ç”¨äºç”ŸæˆäºŒç»´ç ) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <style>
    /* è‡ªå®šä¹‰å­—ä½“ï¼Œå°è¯•åŒ¹é…é¢å•å¸¸è§å­—ä½“ */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Noto+Serif+SC:wght@700&display=swap');

    .font-serif-sc {
      font-family: 'Noto Serif SC', 'SimSun', serif;
    }

    .font-sans-sc {
      font-family: 'Noto Sans SC', 'SimHei', sans-serif;
    }

    /* å¼ºåˆ¶ Canvas åœ¨å±å¹•ä¸Šä¿æŒæ¯”ä¾‹ç¼©æ”¾ï¼Œä¸å½±å“å†…éƒ¨çœŸå®åˆ†è¾¨ç‡ */
    .canvas-container canvas {
      max-width: 100%;
      height: auto;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <div id="app" class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
    <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
      <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ğŸ“¦ é¢å•æ•°æ®å½•å…¥</h2>
      <p class="text-sm text-gray-500">
        ç›®æ ‡å°ºå¯¸: 100mm x 50mm <br>
        è¾“å‡ºåˆ†è¾¨ç‡: 800px x 400px (203 DPI)
      </p>

      <div class="space-y-4">
        <!-- æŠ¬å¤´ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æŠ¬å¤´ (Top Text)</label>
          <input type="text" v-model="form.header" @input="debouncedDraw"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none"
            placeholder="ä¾‹å¦‚ï¼šä¹Œé²æœ¨é½é¾™è…¾">
        </div>

        <!-- å¤§å¤´ç¬”/åˆ†æ‹£ç  -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">å¤§å¤´ç¬” (Sorting Code)</label>
          <input type="text" v-model="form.sortingCode" @input="debouncedDraw"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none"
            placeholder="ä¾‹å¦‚ï¼š62813 (1-)">
        </div>

        <!-- åœ°å€ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">åœ°å€ (Address)</label>
          <input type="text" v-model="form.address" @input="debouncedDraw"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none"
            placeholder="ä¾‹å¦‚ï¼šä¹Œé²æœ¨é½å¸‚å¤´å±¯æ²³åŒº...">
        </div>

        <!-- è¿å•å· -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">è¿å•å· (Tracking No)</label>
          <div class="flex gap-2">
            <input type="text" v-model="form.trackingNo" @input="debouncedDraw"
              class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none font-mono"
              placeholder="ä¾‹å¦‚ï¼šL9I800241">
            <button @click="generateRandomNo"
              class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded text-sm transition">éšæœº</button>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="pt-4 border-t flex gap-4">
        <button @click="drawCanvas"
          class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md transition font-medium">
          åˆ·æ–°é¢„è§ˆ
        </button>
        <button @click="exportBase64"
          class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition font-medium flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          ç”Ÿæˆæ‰“å°çº§ Base64
        </button>
      </div>

      <!-- Base64 è¾“å‡ºåŒºåŸŸ -->
      <div v-if="base64Result" class="mt-4 animate-fade-in">
        <label class="block text-sm font-medium text-gray-700 mb-1">Base64 ç»“æœ (å·²å¤åˆ¶åˆ°å‰ªè´´æ¿)</label>
        <textarea readonly
          class="w-full h-24 text-xs font-mono border border-gray-300 rounded p-2 bg-gray-50 resize-none"
          :value="base64Result"></textarea>
      </div>
    </div>

    <!-- å³ä¾§ï¼šCanvas é¢„è§ˆ -->
    <div class="bg-gray-200 p-6 rounded-lg shadow-inner flex flex-col items-center justify-center relative">
      <h3 class="absolute top-4 left-6 text-sm font-bold text-gray-500 uppercase">Print Preview</h3>

      <div class="canvas-container bg-white shadow-xl">
        <!-- 
                   Width: 800px (100mm @ 203 DPI)
                   Height: 400px (50mm @ 203 DPI)
                -->
        <canvas ref="labelCanvas" width="800" height="400"></canvas>
      </div>

      <p class="mt-4 text-xs text-gray-500">Canvas åŸå§‹å°ºå¯¸: 800px x 400px (ç”¨äº 100mm x 50mm æ‰“å°)</p>
    </div>

  </div>

  <script>
    const { createApp, ref, onMounted, reactive } = Vue;

    createApp({
      setup() {
        const labelCanvas = ref(null);
        const base64Result = ref('');
        let ctx = null;
        let debounceTimer = null;

        // è¡¨å•æ•°æ®
        const form = reactive({
          header: 'ä¹Œé²æœ¨é½é¾™è…¾',
          sortingCode: '62813 (1-)',
          address: 'ä¹Œé²æœ¨é½å¸‚å¤´å±¯æ²³åŒºå¤´å±¯æ²³å…¬è·¯2345å·',
          trackingNo: 'L9I800241'
        });

        // é˜²æŠ–é‡ç»˜
        const debouncedDraw = () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            drawCanvas();
          }, 300);
        };

        const generateRandomNo = () => {
          form.trackingNo = 'L' + Math.floor(Math.random() * 1000000000);
          drawCanvas();
        };

        // æ ¸å¿ƒç»˜åˆ¶é€»è¾‘
        const drawCanvas = async () => {
          if (!labelCanvas.value) return;
          ctx = labelCanvas.value.getContext('2d');
          const width = labelCanvas.value.width;   // 800
          const height = labelCanvas.value.height; // 400

          // 1. æ¸…ç©ºç”»å¸ƒå¹¶å¡«å……ç™½è‰²èƒŒæ™¯
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, width, height);

          // 2. ç»˜åˆ¶ "æŠ¬å¤´" 
          ctx.fillStyle = '#000000';
          ctx.textAlign = 'center';
          // å­—ä½“æ”¾å¤§: 24px -> 34px
          ctx.font = 'bold 34px "SimSun", "Noto Serif SC", serif';
          ctx.fillText(form.header, width / 2, 55);

          // 3. ç»˜åˆ¶ "å¤§å¤´ç¬”/åˆ†æ‹£ç "
          // å­—ä½“æ”¾å¤§: 48px -> 68px
          ctx.font = '68px "Times New Roman", "SimSun", serif';
          ctx.fillText(form.sortingCode, width / 2, 135);

          // 4. ç»˜åˆ¶ "åœ°å€"
          // å­—ä½“æ”¾å¤§: 16px -> 24px
          ctx.font = '24px "SimHei", "Noto Sans SC", sans-serif';
          ctx.fillText(form.address, width / 2, 185);

          // 5. ç»˜åˆ¶ "è¿å•å·æ–‡å­—"
          ctx.textAlign = 'left';
          // å­—ä½“æ”¾å¤§: 42px -> 60px
          ctx.font = 'bold 60px "Arial", sans-serif';
          // åæ ‡è°ƒæ•´: x: 40->50, y: 190->270
          ctx.fillText(form.trackingNo, 50, 270);

          // 6. ç”Ÿæˆå¹¶ç»˜åˆ¶æ¡å½¢ç  (Code128)
          try {
            const tempCanvas = document.createElement('canvas');
            JsBarcode(tempCanvas, form.trackingNo, {
              format: "CODE128",
              width: 4,        // åŠ å®½: 3 -> 4
              height: 80,      // åŠ é«˜: 60 -> 80
              displayValue: false,
              margin: 0
            });
            // åæ ‡è°ƒæ•´: y: 205 -> 290
            ctx.drawImage(tempCanvas, 50, 290);
          } catch (e) {
            console.error("Barcode generation failed", e);
          }

          // 7. ç”Ÿæˆå¹¶ç»˜åˆ¶äºŒç»´ç 
          try {
            // å°ºå¯¸æ”¾å¤§: width: 100 -> 140
            const qrDataUrl = await QRCode.toDataURL(form.trackingNo, {
              width: 140,
              margin: 0,
              errorCorrectionLevel: 'H'
            });

            const qrImage = new Image();
            qrImage.onload = () => {
              // é‡æ–°å®šä½åˆ°å³ä¾§
              // x: ~600, y: ~230
              ctx.drawImage(qrImage, 600, 230, 140, 140);
            };
            qrImage.src = qrDataUrl;

          } catch (e) {
            console.error("QR generation failed", e);
          }
        };

        const exportBase64 = () => {
          if (!labelCanvas.value) return;
          // ä½¿ç”¨é«˜è´¨é‡ PNG
          const dataUrl = labelCanvas.value.toDataURL('image/png', 1.0);
          base64Result.value = dataUrl;

          try {
            const input = document.createElement('input');
            input.setAttribute('value', dataUrl);
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            alert('å·²ç”Ÿæˆé«˜åˆ†è¾¨ç‡ Base64 å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
          } catch (err) {
            alert('Base64 å·²ç”Ÿæˆï¼Œè¯·åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡†å¤åˆ¶ã€‚');
          }
        };

        onMounted(() => {
          setTimeout(drawCanvas, 100);
        });

        return {
          labelCanvas,
          form,
          base64Result,
          debouncedDraw,
          drawCanvas,
          generateRandomNo,
          exportBase64
        };
      }
    }).mount('#app');
  </script>
</body>

</html>